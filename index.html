<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pic-a-Boo(th) - Snap together, giggle together!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Cute background decorations */
        .bg-decoration {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            width: 20px;
            height: 20px;
            background: #fff;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: sparkle 3s ease-in-out infinite;
        }

        .heart {
            width: 15px;
            height: 15px;
            background: #ff69b4;
            position: relative;
            transform: rotate(-45deg);
            animation: float 4s ease-in-out infinite;
        }

        .heart:before,
        .heart:after {
            content: '';
            width: 15px;
            height: 15px;
            position: absolute;
            left: 7.5px;
            top: 0;
            background: #ff69b4;
            border-radius: 50%;
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }

        .heart:after {
            left: 0;
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        @keyframes float {
            0%, 100% { transform: rotate(-45deg) translateY(0px); }
            50% { transform: rotate(-45deg) translateY(-10px); }
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #ff1493;
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px #ff69b4;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #ff69b4;
            font-weight: bold;
        }

        /* Page styles */
        .page {
            display: none;
            min-height: 100vh;
            padding-top: 20px;
        }

        .page.active {
            display: block;
        }

        /* Home Page */
        .home-page {
            display: block;
            text-align: center;
            min-height: 100vh;
        }

        .home-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
            border: 3px solid #ff69b4;
            max-width: 600px;
            margin: 0 auto;
        }

        .home-title {
            color: #ff1493;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .home-subtitle {
            color: #ff69b4;
            font-size: 1.3rem;
            margin-bottom: 30px;
        }

        .mode-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-option {
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #ff69b4;
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 250px;
            text-align: center;
        }

        .mode-option:hover {
            background: #ff69b4;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.5);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mode-desc {
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Room Setup Page */
        .setup-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
            border: 3px solid #ff69b4;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .setup-title {
            color: #ff1493;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .setup-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .setup-option {
            padding: 20px;
            border: 2px solid #ff69b4;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setup-option:hover {
            background: #ff69b4;
            color: white;
            transform: translateY(-2px);
        }

        .room-input {
            display: none;
            margin-top: 20px;
        }

        .room-input.active {
            display: block;
        }

        .room-code-input {
            padding: 15px;
            border: 2px solid #ff69b4;
            border-radius: 25px;
            font-size: 1.2rem;
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .room-code-display {
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .share-link {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ff69b4;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .copy-btn {
            background: #32cd32;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #228b22;
            transform: translateY(-2px);
        }

        .status-message {
            color: #ff1493;
            font-weight: bold;
            margin-top: 10px;
            min-height: 25px;
        }

        /* Camera Page */
        .camera-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
            border: 3px solid #ff69b4;
        }

        .cameras-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .single-camera {
            grid-template-columns: 1fr;
            max-width: 600px;
            margin: 0 auto;
        }

        .camera-frame {
            position: relative;
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.4);
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #fff;
        }

        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #ff1493;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 10;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
        }

        .status-disconnected {
            background: #f44336;
            color: white;
        }

        .camera-unavailable {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff69b4;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            border-radius: 12px;
        }

        .flash-overlay.active {
            opacity: 0.8;
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: #ff1493;
            font-weight: bold;
            text-shadow: 3px 3px 0px #fff;
            z-index: 100;
            display: none;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            font-size: 0.9rem;
            color: #ff1493;
            font-weight: bold;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #ff69b4;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #ff1493;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover {
            background: #ff69b4;
            color: white;
            transform: translateY(-2px);
        }

        .capture-btn {
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            color: white;
            font-size: 1.2rem;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
        }

        .capture-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .capture-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Strip Page */
        .strip-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
            border: 3px solid #ff69b4;
            text-align: center;
        }

        .strip-preview {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .photo-strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .strip-title {
            font-size: 1.2rem;
            color: #ff1493;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .strip-photo {
            width: 150px;
            height: 120px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #ff69b4;
        }

        .combined-strip {
            display: none;
            max-width: 400px;
        }

        .combined-strip.active {
            display: block;
        }

        .combined-photo {
            width: 300px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #ff69b4;
        }

        .strip-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .back-btn {
            background: linear-gradient(45deg, #ffa500, #ff6347);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: linear-gradient(45deg, #32cd32, #228b22);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .home-btn {
            background: linear-gradient(45deg, #9370db, #8a2be2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover, .download-btn:hover, .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .mode-options {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-option {
                width: 100%;
                max-width: 300px;
            }
            
            .cameras-grid {
                grid-template-columns: 1fr;
            }
            
            .video-container {
                height: 250px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .strip-preview {
                flex-direction: column;
                align-items: center;
            }
            
            .countdown {
                font-size: 3rem;
            }
        }
        @media (max-width: 480px) {
            .home-container, .setup-container, .camera-container, .strip-container {
                padding: 20px;
                margin: 10px;
            }
            
            .video-container {
                height: 200px;
            }
            
            .controls {
                gap: 10px;
            }
            
            .control-group {
                min-width: 120px;
            }
            
            select, button {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .strip-photo {
                width: 120px;
                height: 96px;
            }
            
            .combined-photo {
                width: 240px;
                height: 120px;
            }
        }
        
        /* Touch-friendly buttons */
        @media (hover: none) {
            .mode-option:hover,
            .setup-option:hover,
            select:hover,
            button:hover {
                transform: none;
            }
            
            .mode-option:active,
            .setup-option:active,
            select:active,
            button:active {
                transform: scale(0.95);
            }
        }
    </style>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyC9tPt6qMlvVES1gUu66eD1sioiv0P-NEM",
        authDomain: "pic-a-booth-41a40.firebaseapp.com",
        databaseURL: "https://pic-a-booth-41a40-default-rtdb.firebaseio.com",
        projectId: "pic-a-booth-41a40",
        storageBucket: "pic-a-booth-41a40.firebasestorage.app",
        messagingSenderId: "679511538478",
        appId: "1:679511538478:web:dc0fe55df5854996f598bf"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // Make these available globally
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseOnChildAdded = onChildAdded;
    </script>
</head>
<body>
    <!-- Background decorations -->
    <div class="bg-decoration star" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
    <div class="bg-decoration heart" style="top: 20%; right: 15%; animation-delay: 1s;"></div>
    <div class="bg-decoration star" style="bottom: 20%; left: 20%; animation-delay: 0.5s;"></div>
    <div class="bg-decoration heart" style="bottom: 30%; right: 25%; animation-delay: 1.5s;"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">Pic-a-Boo(th)</h1>
            <p class="subtitle">‚ú® Snap together, giggle together! ‚ú®</p>
        </div>

        <!-- Home Page -->
        <div class="page home-page" id="homePage">
            <div class="home-container">
                <h2 class="home-title">Welcome to Pic-a-Boo(th)!</h2>
                <p class="home-subtitle">Choose your photo adventure!</p>
                
                <div class="mode-options">
                    <div class="mode-option" onclick="startIndividualMode()">
                        <div class="mode-icon">ü§≥</div>
                        <div class="mode-title">Individual</div>
                        <div class="mode-desc">Take solo selfies and create your own photo strip!</div>
                    </div>
                    
                    <div class="mode-option" onclick="startFriendsMode()">
                        <div class="mode-icon">üëØ</div>
                        <div class="mode-title">With Friends</div>
                        <div class="mode-desc">Connect with a friend and take photos together!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Setup Page -->
        <div class="page" id="roomSetupPage">
            <div class="setup-container">
                <h2 class="setup-title">Let's Connect! üíï</h2>
                
                <div class="setup-options">
                    <div class="setup-option" onclick="createRoom()">
                        <h3>üéâ Create New Room</h3>
                        <p>Start a new photo session and share the code with your friend!</p>
                    </div>
                    
                    <div class="setup-option" onclick="showJoinRoom()">
                        <h3>ü§ù Join Room</h3>
                        <p>Enter your friend's room code to join their session!</p>
                    </div>
                </div>

                <div class="room-input" id="createRoomInput">
                    <div class="room-code-display" id="roomCodeDisplay"></div>
                    <div class="share-link" id="shareLink"></div>
                    <p style="margin-bottom: 20px;">Share this code and link with your friend!</p>
                    <button class="capture-btn" onclick="startSession()">Start Session</button>
                </div>

                <div class="room-input" id="joinRoomInput">
                    <input type="text" class="room-code-input" id="roomCodeInput" placeholder="Enter room code" maxlength="6">
                    <button class="capture-btn" onclick="joinRoom()">Join Room</button>
                </div>

                <div class="status-message" id="statusMessage"></div>
                
                <div style="margin-top: 20px;">
                    <button class="home-btn" onclick="goHome()">üè† Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Camera Page -->
        <div class="page" id="cameraPage">
            <div class="camera-container">
                <div class="cameras-grid" id="camerasGrid">
                    <div class="camera-frame">
                        <div class="video-container">
                            <div class="camera-label" id="cameraLabel1">You</div>
                            <div class="connection-status status-connected" id="myStatus">Ready</div>
                            <video id="localVideo" class="video-feed" autoplay muted playsinline></video>
                            <div class="camera-unavailable" id="localCameraUnavailable" style="display: none;">
                                <p>üì∑ Camera not available</p>
                                <button onclick="requestCamera()">Enable Camera</button>
                            </div>
                            <div class="flash-overlay" id="localFlash"></div>
                        </div>
                    </div>

                    <div class="camera-frame" id="friendCameraFrame">
                        <div class="video-container">
                            <div class="camera-label">Friend</div>
                            <div class="connection-status status-disconnected" id="friendStatus">Waiting...</div>
                            <video id="remoteVideo" class="video-feed" autoplay playsinline></video>
                            <div class="camera-unavailable" id="remoteCameraUnavailable">
                                <p>üîó Waiting for friend...</p>
                            </div>
                            <div class="flash-overlay" id="remoteFlash"></div>
                        </div>
                    </div>
                </div>

                <div class="countdown" id="countdown"></div>

                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">Mirror</label>
                        <select id="mirrorSelect">
                            <option value="off">Off</option>
                            <option value="on" selected>On</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Filter</label>
                        <select id="filterSelect">
                            <option value="original">Original</option>
                            <option value="bw">Black & White</option>
                            <option value="vintage">Vintage</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Flash</label>
                        <select id="flashSelect">
                            <option value="off">Off</option>
                            <option value="on">On</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="capture-btn" id="captureBtn" onclick="startPhotoSession()">
                        üì∏ Take 4 Photos
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                    <button class="home-btn" onclick="goHome()">üè† Back to Home</button>
                </div>
            </div>
        </div>

        //strip filters 
        <div class="control-group">
            <label class="control-label">Background</label>
            <select id="backgroundSelect">
                <option value="none">None</option>
                <option value="hearts">Hearts</option>
                <option value="stars">Stars</option>
                <option value="gradient">Gradient</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Stickers</label>
            <select id="stickerSelect">
                <option value="none">None</option>
                <option value="cute">Cute</option>
                <option value="party">Party</option>
                <option value="love">Love</option>
            </select>
        </div>
        <!-- Strip Page -->
        <div class="page" id="stripPage">
            <div class="strip-container">
                <h2 style="color: #ff1493; margin-bottom: 20px;">Your Photo Strip! üíï</h2>
                
                <div class="strip-preview">
                    <div class="photo-strip" id="myStrip">
                        <div class="strip-title" id="stripTitle1">You</div>
                        <img class="strip-photo" id="myPhoto1" alt="Your Photo 1">
                        <img class="strip-photo" id="myPhoto2" alt="Your Photo 2">
                        <img class="strip-photo" id="myPhoto3" alt="Your Photo 3">
                        <img class="strip-photo" id="myPhoto4" alt="Your Photo 4">
                    </div>

                    <div class="photo-strip" id="friendStrip">
                        <div class="strip-title">Friend</div>
                        <img class="strip-photo" id="friendPhoto1" alt="Friend Photo 1">
                        <img class="strip-photo" id="friendPhoto2" alt="Friend Photo 2">
                        <img class="strip-photo" id="friendPhoto3" alt="Friend Photo 3">
                        <img class="strip-photo" id="friendPhoto4" alt="Friend Photo 4">
                    </div>

                    <div class="photo-strip combined-strip" id="combinedStrip">
                        <div class="strip-title">Together</div>
                        <img class="combined-photo" id="combinedPhoto1" alt="Combined Photo 1">
                        <img class="combined-photo" id="combinedPhoto2" alt="Combined Photo 2">
                        <img class="combined-photo" id="combinedPhoto3" alt="Combined Photo 3">
                        <img class="combined-photo" id="combinedPhoto4" alt="Combined Photo 4">
                    </div>
                </div>

                <div class="strip-controls" id="viewModeControls">
                    <div class="control-group">
                        <label class="control-label">View Mode</label>
                        <select id="viewModeSelect">
                            <option value="separate">Separate Strips</option>
                            <option value="combined">Combined Strip</option>
                        </select>
                    </div>
                </div>

                <div class="strip-controls">
                    <button class="back-btn" onclick="retakePhotos()">üì∑ Retake Photos</button>
                    <button class="download-btn" onclick="downloadStrips()">üíæ Download</button>
                    <button class="home-btn" onclick="goHome()">üè† Home</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App state
        let currentPage = 'homePage';
        let appMode = 'individual'; // 'individual' or 'friends'
        let localVideo = document.getElementById('localVideo');
        let remoteVideo = document.getElementById('remoteVideo');
        let localStream = null;
        let peerConnection = null;
        let dataChannel = null;
        let roomCode = null;
        let isHost = false;
        let isConnected = false;
        let myPhotos = [];
        let friendPhotos = [];
        let currentFilter = 'original';
        let mirrorMode = true;
        let flashMode = false;
        let isCapturing = false;

        // WebRTC configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Simple signaling server simulation
        const signaling = {
            send: function(roomCode, message) {
                // Save the signaling message to Firebase
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${roomCode}`);
                window.firebasePush(roomRef, message);
            },
            receive: function(roomCode, callback) {
                // Listen for new signaling messages in Firebase
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${roomCode}`);
                window.firebaseOnChildAdded(roomRef, (snapshot) => {
                    callback(snapshot.val());
                });
            }
        };

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            // Show current page
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
        }

        function goHome() {
            // Clean up any existing streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Reset state
            isConnected = false;
            isCapturing = false;
            myPhotos = [];
            friendPhotos = [];
            roomCode = null;
            
            showPage('homePage');
        }

        // Mode selection
        function startIndividualMode() {
            appMode = 'individual';
            showPage('cameraPage');
            setupIndividualCamera();
        }

        function startFriendsMode() {
            appMode = 'friends';
            showPage('roomSetupPage');
        }

        // Setup individual camera
        async function setupIndividualCamera() {
            // Hide friend camera frame
            document.getElementById('friendCameraFrame').style.display = 'none';
            document.getElementById('camerasGrid').classList.add('single-camera');
            document.getElementById('cameraLabel1').textContent = 'You';
            document.getElementById('captureBtn').textContent = 'üì∏ Take 4 Photos';
            
            try {
                await initCamera();
                document.getElementById('myStatus').textContent = 'Ready';
                document.getElementById('localCameraUnavailable').style.display = 'none';
            } catch (error) {
                 console.error('Error accessing camera:', error);
                document.getElementById('localCameraUnavailable').style.display = 'block';
                document.getElementById('myStatus').textContent = 'Camera Error';
                document.getElementById('myStatus').className = 'connection-status status-disconnected';
            }
        }
        // Room management
        function createRoom() {
            roomCode = generateRoomCode();
            isHost = true;
            
            document.getElementById('roomCodeDisplay').textContent = roomCode;
            document.getElementById('shareLink').textContent = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            document.getElementById('createRoomInput').classList.add('active');
            document.getElementById('joinRoomInput').classList.remove('active');
            document.getElementById('statusMessage').textContent = 'Room created! Share the code with your friend.';
        }

        function showJoinRoom() {
            document.getElementById('joinRoomInput').classList.add('active');
            document.getElementById('createRoomInput').classList.remove('active');
            document.getElementById('statusMessage').textContent = 'Enter your friend\'s room code to join.';
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function joinRoom() {
            const inputCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (inputCode.length === 6) {
                roomCode = inputCode;
                isHost = false;
                document.getElementById('statusMessage').textContent = 'Joining room...';
                startSession();
            } else {
                document.getElementById('statusMessage').textContent = 'Please enter a valid 6-character room code.';
            }
        }

        function startSession() {
            if (roomCode) {
                showPage('cameraPage');
                setupFriendsCamera();
            }
        }
        // Setup friends camera
        async function setupFriendsCamera() {
            // Show both camera frames
            document.getElementById('friendCameraFrame').style.display = 'block';
            document.getElementById('camerasGrid').classList.remove('single-camera');
            document.getElementById('cameraLabel1').textContent = 'You';
            document.getElementById('captureBtn').textContent = 'üì∏ Take 4 Photos Together';
            
            try {
                await initCamera();
                await initWebRTC();
                document.getElementById('myStatus').textContent = 'Connected';
                document.getElementById('localCameraUnavailable').style.display = 'none';
            } catch (error) {
                console.error('Error setting up friends camera:', error);
                document.getElementById('localCameraUnavailable').style.display = 'block';
                document.getElementById('myStatus').textContent = 'Connection Error';
                document.getElementById('myStatus').className = 'connection-status status-disconnected';
            }
        }
         // Initialize camera
        async function initCamera() {
            try {
                const constraints = {
                    video: { 
                        width: { ideal: 640, min: 320 }, 
                        height: { ideal: 480, min: 240 },
                        facingMode: 'user',
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: false
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                
                // Apply mirror effect
                updateMirrorMode();
                updateFilter();
                
                return true;
            } catch (error) {
                console.error('Camera initialization failed:', error);
                throw error;
            }
        }
        // WebRTC initialization
        async function initWebRTC() {
            if (appMode !== 'friends') return;
            
            try {
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add local stream
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                    document.getElementById('friendStatus').textContent = 'Connected';
                    document.getElementById('friendStatus').className = 'connection-status status-connected';
                    document.getElementById('remoteCameraUnavailable').style.display = 'none';
                    isConnected = true;
                };
                
                // Create data channel for synchronization
                if (isHost) {
                    dataChannel = peerConnection.createDataChannel('photos');
                    dataChannel.onopen = () => console.log('Data channel opened');
                    dataChannel.onmessage = handleDataChannelMessage;
                } else {
                    peerConnection.ondatachannel = (event) => {
                        dataChannel = event.channel;
                        dataChannel.onmessage = handleDataChannelMessage;
                    };
                }
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        signaling.send(roomCode, {
                            type: 'ice-candidate',
                            candidate: event.candidate
                        });
                    }
                };
                
                //Monitor connection state
                peerConnection.onconnectionstatechange = () => {
                    console.log('Connection state:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        document.getElementById('friendStatus').textContent = 'Connected';
                        document.getElementById('friendStatus').className = 'connection-status status-connected';
                        isConnected = true;
                    } else if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                        document.getElementById('friendStatus').textContent = 'Disconnected';document.getElementById('friendStatus').className = 'connection-status status-disconnected';
        isConnected = false;
    }
};

                // Start signaling (host creates offer)
                if (isHost) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    signaling.send(roomCode, {
                        type: 'offer',
                        offer: offer
                    });
                }
                
                // Listen for signaling messages from Firebase
                signaling.receive(roomCode, async (message) => {
                    if (!peerConnection) {
                        console.error("peerConnection not initialized");
                        return;
                    }
                    
                    try {
                        if (message.type === 'offer' && !isHost) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            signaling.send(roomCode, {
                                type: 'answer',
                                answer: answer
                            });
                        
                        } else if (message.type === 'answer' && isHost) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                        
                        } else if (message.type === 'ice-candidate') {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        }
                    } catch (error) {
                        console.error('Error handling signaling message:', error);
                    }
                });
            
            } catch (error) {
                console.error('WebRTC initialization failed:', error);
                throw error;
            }
        }

        // Handle signaling messages
        async function handleSignalingMessage(message) {
            try {
                if (message.type === 'offer' && !isHost) {
                    await peerConnection.setRemoteDescription(message.offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    signaling.send(roomCode, {
                        type: 'answer',
                        answer: answer
                    });
                } else if (message.type === 'answer' && isHost) {
                    await peerConnection.setRemoteDescription(message.answer);
                } else if (message.type === 'ice-candidate') {
                    await peerConnection.addIceCandidate(message.candidate);
                }
            } catch (error) {
                console.error('Signaling error:', error);
            }
        }

        // Handle data channel messages
        function handleDataChannelMessage(event) {
            const message = JSON.parse(event.data);
            if (message.type === 'photo') {
                friendPhotos.push(message.photoData);
                if (friendPhotos.length === 4) {
                    showPhotoStrip();
                }
            } else if (message.type === 'countdown') {
                showCountdown(message.count);
            }
        }

        // Photo capture functionality
        async function startPhotoSession() {
            if (isCapturing) return;
            
            isCapturing = true;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('captureBtn').textContent = 'Taking Photos...';
            
            myPhotos = [];
            friendPhotos = [];
            
            for (let i = 0; i < 4; i++) {
                await capturePhoto(i + 1);
                if (i < 3) {
                    await wait(2000); // Wait 2 seconds between photos
                }
            }

            // Wait for friend's photos if in friends mode
            if (appMode === 'friends' && friendPhotos.length < 4) {
                document.getElementById('captureBtn').textContent = 'Waiting for friend...';
                // Set timeout to proceed even if friend is not ready
                setTimeout(() => {
                    if (friendPhotos.length < 4) {
                        // Fill missing photos with placeholder
                        while (friendPhotos.length < 4) {
                            friendPhotos.push(createPlaceholderImage());
                        }
                        showPhotoStrip();
                    }
                }, 10000);
            } else {
                showPhotoStrip();
            }
        }

        async function capturePhoto(photoNumber) {
            // Show countdown
            await showCountdown(3);
            
            // Apply flash effect
            if (flashMode || document.getElementById('flashSelect').value === 'on') {
                triggerFlash();
            }
            
            // Capture photo
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = localVideo.videoWidth;
            canvas.height = localVideo.videoHeight;
            
            // Apply mirror effect if enabled
            if (mirrorMode) {
                ctx.scale(-1, 1);
                ctx.translate(-canvas.width, 0);
            }
            
            ctx.drawImage(localVideo, 0, 0);
            
            // Apply filter
            applyCanvasFilter(ctx, canvas);
            
            const photoData = canvas.toDataURL('image/jpeg', 0.8);
            myPhotos.push(photoData);
            
            // Send photo to friend if in friends mode
            if (appMode === 'friends' && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify({
                    type: 'photo',
                    photoData: photoData
                }));
            }
            
            console.log(`Photo ${photoNumber} captured`);
        }

        function showCountdown(startCount) {
            return new Promise((resolve) => {
                const countdownElement = document.getElementById('countdown');
                countdownElement.style.display = 'block';
                
                let count = startCount;
                countdownElement.textContent = count;
                
                // Send countdown to friend
                if (appMode === 'friends' && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({
                        type: 'countdown',
                        count: count
                    }));
                }
                
                const timer = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownElement.textContent = count;
                        if (appMode === 'friends' && dataChannel && dataChannel.readyState === 'open') {
                            dataChannel.send(JSON.stringify({
                                type: 'countdown',
                                count: count
                            }));
                        }
                    } else {
                        countdownElement.style.display = 'none';
                        clearInterval(timer);
                        resolve();
                    }
                }, 1000);
            });
        }

        function triggerFlash() {
            document.getElementById('localFlash').classList.add('active');
            if (appMode === 'friends') {
                document.getElementById('remoteFlash').classList.add('active');
            }
            
            setTimeout(() => {
                document.getElementById('localFlash').classList.remove('active');
                if (appMode === 'friends') {
                    document.getElementById('remoteFlash').classList.remove('active');
                }
            }, 300);
        }

        // Show photo strip
        function showPhotoStrip() {
            isCapturing = false;
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('captureBtn').textContent = 'üì∏ Take 4 Photos';
            
            // Display photos
            for (let i = 0; i < 4; i++) {
                if (myPhotos[i]) {
                    document.getElementById(`myPhoto${i + 1}`).src = myPhotos[i];
                }
                
                if (appMode === 'friends' && friendPhotos[i]) {
                    document.getElementById(`friendPhoto${i + 1}`).src = friendPhotos[i];
                }
            }

            // Set up view mode
            if (appMode === 'individual') {
                document.getElementById('friendStrip').style.display = 'none';
                document.getElementById('combinedStrip').style.display = 'none';
                document.getElementById('viewModeControls').style.display = 'none';
                document.getElementById('stripTitle1').textContent = 'Your Photos';
            } else {
                document.getElementById('friendStrip').style.display = 'block';
                document.getElementById('viewModeControls').style.display = 'block';
                document.getElementById('stripTitle1').textContent = 'You';
                
                // Create combined photos
                createCombinedPhotos();
            }
            
            showPage('stripPage');
        }

        // Create combined photos
        function createCombinedPhotos() {
            for (let i = 0; i < 4; i++) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 600;
                canvas.height = 300;
                
                // Create images
                const myImg = new Image();
                const friendImg = new Image();
                
                let imagesLoaded = 0;
                
                const drawCombined = () => {
                    imagesLoaded++;
                    if (imagesLoaded === 2) {
                        // Draw my photo on left
                        ctx.drawImage(myImg, 0, 0, 300, 300);
                        
                        // Draw friend's photo on right
                        ctx.drawImage(friendImg, 300, 0, 300, 300);
                        
                        // Add border
                        ctx.strokeStyle = '#ff69b4';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(0, 0, 600, 300);
                        ctx.strokeRect(300, 0, 300, 300);
                        
                        const combinedData = canvas.toDataURL('image/jpeg', 0.8);
                        document.getElementById(`combinedPhoto${i + 1}`).src = combinedData;
                    }
                };
                
                myImg.onload = drawCombined;
                friendImg.onload = drawCombined;
                
                myImg.src = myPhotos[i] || createPlaceholderImage();
                friendImg.src = friendPhotos[i] || createPlaceholderImage();
            }
        }

        // View mode toggle
        document.getElementById('viewModeSelect').addEventListener('change', (e) => {
            if (e.target.value === 'combined') {
                document.getElementById('myStrip').style.display = 'none';
                document.getElementById('friendStrip').style.display = 'none';
                document.getElementById('combinedStrip').classList.add('active');
            } else {
                document.getElementById('myStrip').style.display = 'block';
                document.getElementById('friendStrip').style.display = 'block';
                document.getElementById('combinedStrip').classList.remove('active');
            }
        });

        // Filter and mirror controls
        document.getElementById('mirrorSelect').addEventListener('change', updateMirrorMode);
        document.getElementById('filterSelect').addEventListener('change', updateFilter);
        document.getElementById('flashSelect').addEventListener('change', (e) => {
            flashMode = e.target.value === 'on';
        });

        function updateMirrorMode() {
            mirrorMode = document.getElementById('mirrorSelect').value === 'on';
            localVideo.style.transform = mirrorMode ? 'scaleX(-1)' : 'scaleX(1)';
        }

        function updateFilter() {
            currentFilter = document.getElementById('filterSelect').value;
            let filterCSS = '';
            
            switch (currentFilter) {
                case 'bw':
                    filterCSS = 'grayscale(100%)';
                    break;
                case 'vintage':
                    filterCSS = 'sepia(100%) hue-rotate(30deg) saturate(1.2)';
                    break;
                default:
                    filterCSS = 'none';
            }
            
            localVideo.style.filter = filterCSS;
        }

        function applyCanvasFilter(ctx, canvas) {
            if (currentFilter === 'bw') {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = gray;
                    data[i + 1] = gray;
                    data[i + 2] = gray;
                }
                
                ctx.putImageData(imageData, 0, 0);
            } else if (currentFilter === 'vintage') {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, data[i] * 1.2);
                    data[i + 1] = Math.min(255, data[i + 1] * 1.1);
                    data[i + 2] = Math.min(255, data[i + 2] * 0.8);
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
        }
        document.getElementById('backgroundSelect').addEventListener('change', updateBackground);
        document.getElementById('stickerSelect').addEventListener('change', updateStickers);
        
        function updateBackground() {
            const background = document.getElementById('backgroundSelect').value;
            const videoContainers = document.querySelectorAll('.video-container');
            
            videoContainers.forEach(container => {
                switch(background) {
                    case 'hearts':
                        container.style.background = 'radial-gradient(circle, #ff69b4 1px, transparent 1px), radial-gradient(circle, #ff1493 1px, transparent 1px)';
                        container.style.backgroundSize = '20px 20px, 40px 40px';
                        break;
                    case 'stars':
                        container.style.background = 'radial-gradient(circle, #ffd700 1px, transparent 1px)';
                        container.style.backgroundSize = '25px 25px';
                        break;
                    case 'gradient':
                        container.style.background = 'linear-gradient(45deg, #ff9a9e, #fecfef)';
                        break;
                    default:
                        container.style.background = '#000';
                }
            });
        }
        
        function updateStickers() {
            const sticker = document.getElementById('stickerSelect').value;
            // This will be implemented in the capture function
            }
            
        // Utility functions
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function createPlaceholderImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 300;
            canvas.height = 300;
            
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 300, 300);
            
            ctx.fillStyle = '#ccc';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Photo not available', 150, 150);
            
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // Download functionality - creates actual photo strips
        function downloadStrips() {
            if (appMode === 'individual') {
                // Create individual photo strip
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 400;
                canvas.height = 800;
                
                // White background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw photos
                myPhotos.forEach((photo, index) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 50, 50 + (index * 180), 300, 150);
                        
                        // Add border
                        ctx.strokeStyle = '#ff69b4';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(50, 50 + (index * 180), 300, 150);
                        
                        if (index === 3) {
                            // Add title
                            ctx.fillStyle = '#ff1493';
                            ctx.font = 'bold 24px Comic Sans MS';
                            ctx.textAlign = 'center';
                            ctx.fillText('Pic-a-Boo(th)', canvas.width / 2, 30);
                            
                            // Download
                            const a = document.createElement('a');
                            a.href = canvas.toDataURL('image/jpeg', 0.9);
                            a.download = 'pic-a-booth-strip.jpg';
                            a.click();
                        }
                    };
                    img.src = photo;
                });
            } else {
                // Create combined photo strip
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 800;
                canvas.height = 800;
                
                // White background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw combined photos
                for (let i = 0; i < 4; i++) {
                    const myImg = new Image();
                    const friendImg = new Image();
                    
                    let imagesLoaded = 0;
                    
                    const drawStrip = () => {
                        imagesLoaded++;
                        if (imagesLoaded === 2) {
                            const yPos = 50 + (i * 180);
                            
                            // Draw my photo (left)
                            ctx.drawImage(myImg, 50, yPos, 300, 150);
                            
                            // Draw friend's photo (right)
                            ctx.drawImage(friendImg, 450, yPos, 300, 150);
                            
                            // Add borders
                            ctx.strokeStyle = '#ff69b4';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(50, yPos, 300, 150);
                            ctx.strokeRect(450, yPos, 300, 150);
                            
                            if (i === 3) {
                                // Add title
                                ctx.fillStyle = '#ff1493';
                                ctx.font = 'bold 24px Comic Sans MS';
                                ctx.textAlign = 'center';
                                ctx.fillText('Pic-a-Boo(th)', canvas.width / 2, 30);
                                
                                // Download
                                const a = document.createElement('a');
                                a.href = canvas.toDataURL('image/jpeg', 0.9);
                                a.download = 'pic-a-booth-friends-strip.jpg';
                                a.click();
                            }
                        }
                    };
                    
                    myImg.onload = drawStrip;
                    friendImg.onload = drawStrip;
                    
                    myImg.src = myPhotos[i] || createPlaceholderImage();
                    friendImg.src = friendPhotos[i] || createPlaceholderImage();
                }
            }
        }

        // Retake photos
        function retakePhotos() {
            myPhotos = [];
            friendPhotos = [];
            isCapturing = false;
            
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('captureBtn').textContent = appMode === 'individual' ? 'üì∏ Take 4 Photos' : 'üì∏ Take 4 Photos Together';
            
            showPage('cameraPage');
        }

        // Request camera permission
        async function requestCamera() {
            try {
                await initCamera();
                document.getElementById('localCameraUnavailable').style.display = 'none';
                document.getElementById('myStatus').textContent = 'Ready';
                document.getElementById('myStatus').className = 'connection-status status-connected';
            } catch (error) {
                console.error('Camera access denied:', error);
                alert('Camera access is required for this app to work. Please enable camera permissions and refresh the page.');
            }
        }

        // Initialize app
        function initApp() {
            // Check for room code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            
            if (roomFromUrl) {
                roomCode = roomFromUrl;
                document.getElementById('roomCodeInput').value = roomCode;
                appMode = 'friends';
                showPage('roomSetupPage');
                document.getElementById('statusMessage').textContent = 'Room code loaded from link. Click Join Room to connect.';
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>